<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  </head>
  <body>
    <h1>Paste data here:</h1>
    <textarea style="width: 100%;" id="toImport" rows="25"></textarea>
    <button class="blue" id="importDataBtn">Import</button>
    <button class="" id="ClearBtn">Clear</button>
    <button class="" id="testBtn">Test</button>
    <div id="nextSteps"></div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>
      $(function() {
        $('#importDataBtn').click(runImportData);
        $('#ClearBtn').click(function () {
          $('#toImport').val('');
          $('#nextSteps').html('');
        });
        $('#testBtn').click(function () {displayErrors();});
      });
      
      function displayErrors(retData) {
          if (retData === undefined) {
            retData = 'item1,10:item2,220'.split(':'); //{'item1', 10},{'item2', 220};
            retData.forEach(function(item, index, array) {
              array[index] = array[index].split(',');
            });
          }
          if (retData.length == 0) {
            $('#nextSteps').append('<h3>Complete!</h3>');
            return;
          }
          var nonImportTotal = 0;
          var i = 0;
          $('#nextSteps').append('<h3>No match for these:</h3>');
          retData.forEach(function(item, index, array) {
            nonImportTotal = Number(nonImportTotal) + Number(item[1]);
            let thisRowNumber = i;
            let btnID = 'btn-' + i;
            let lblID = 'lbl-' + i;
            let $newLbl = $('<label />')
              .attr({id: lblID, for: btnID, class: 'error'})
              .text('New expense "' + item[0] + '" for $' + Number(item[1]).toFixed(2) + '?');
            let $newBtn = $('<button />')
              .attr({id: btnID, style: 'margin: 5px;margin-bottom: 2px'})
              .text('Add')
              .click(function () {testClick(thisRowNumber)});
            let $newDiv = $('<div />')
              .attr({id: 'row-' + i});
            $newDiv.append($newBtn, $newLbl);
            $('#nextSteps').append($newDiv);
            i++;
          });
          $('#nextSteps').append('<h4>Not imported total: $' + nonImportTotal.toFixed(2) + '</h4>');
      }
      
      function runImportData() {
        var MyData;
        
        $('#nextSteps').html('');
        MyData = $('#toImport').val();
        if (MyData.indexOf('\t') > 0) {
          MyData = MyData.split(',').join('');
          MyData = MyData.split('\t').join(',');
        }
        MyData = MyData.split('\n');
        MyData.forEach(function(item, index, array) {
          array[index] = array[index].split(',');
        });
        google.script.run.withSuccessHandler(onReturn)
          .importData(MyData);
      }
      
      function onReturn(MyData) {
        displayErrors(MyData);
      }
      
      function testClick(param) {
        $('#nextSteps').append('<p>clicked ' + param + '</p>');
      }
    </script>
  </body>
</html>


